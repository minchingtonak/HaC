services:
  gluetun:
    image: qmcgaw/gluetun:v3.40.1@sha256:dc38bac12b40bb935e477f0dbd88adf174001c84b144c86648b25ff5f14ef54a
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    # ports:
    #   - 8081:8081 # qbittorrent web interface
    #   - 6881:6881 # qbittorrent torrent port
    #   - 6789:6789 # nzbget
    #   # - "5030:5030" # slskd http
    #   - "5031:5031" # slskd https
    #   - "50300:50300" # Soulseek
    volumes:
      - /docker/gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=airvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY={{{SECRET_WIREGUARD_PRIVATE_KEY}}}
      - WIREGUARD_PRESHARED_KEY={{{SECRET_WIREGUARD_PRESHARED_KEY}}}
      - WIREGUARD_ADDRESSES={{{SECRET_WIREGUARD_ADDRESSES}}}
      - FIREWALL_VPN_INPUT_PORTS=29730
      - SERVER_COUNTRIES=United States
      - HEALTH_VPN_DURATION_INITIAL=120s
      - UPDATER_PERIOD=24h
    depends_on:
      deunhealth:
        condition: service_started
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 60s
      timeout: 20s
      retries: 5
    restart: unless-stopped
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.qbittorrent.rule=Host(`{{{domainForApp "qbittorrent"}}}`)
      - traefik.http.routers.qbittorrent.entrypoints=https
      - traefik.http.routers.qbittorrent.tls=true
      - traefik.http.routers.qbittorrent.tls.certresolver=porkbun
      - traefik.http.routers.qbittorrent.service=qbittorrent
      - traefik.http.services.qbittorrent.loadbalancer.server.port=8081
      - traefik.http.routers.qbittorrent.middlewares=oidc-auth@file
      #
      - traefik.tcp.routers.qbittorrent-bittorrent.rule=HostSNI(`*`)
      - traefik.tcp.routers.qbittorrent-bittorrent.entrypoints=qbittorrent-6881-tcp
      - traefik.tcp.routers.qbittorrent-bittorrent.service=qbittorrent-bittorrent
      - traefik.tcp.services.qbittorrent-bittorrent.loadbalancer.server.port=6881
      #
      - traefik.http.routers.nzbget.rule=Host(`{{{domainForApp "nzbget"}}}`)
      - traefik.http.routers.nzbget.entrypoints=https
      - traefik.http.routers.nzbget.tls=true
      - traefik.http.routers.nzbget.tls.certresolver=porkbun
      - traefik.http.routers.nzbget.service=nzbget
      - traefik.http.services.nzbget.loadbalancer.server.port=6789
      - traefik.http.routers.nzbget.middlewares=oidc-auth@file
      #
      - traefik.http.routers.slskd.rule=Host(`{{{domainForApp "slskd"}}}`)
      - traefik.http.routers.slskd.entrypoints=https
      - traefik.http.routers.slskd.tls=true
      - traefik.http.routers.slskd.tls.certresolver=porkbun
      - traefik.http.routers.slskd.service=slskd
      - traefik.http.services.slskd.loadbalancer.server.port=5030
      - traefik.http.routers.slskd.middlewares=oidc-auth@file
      # https://doc.traefik.io/traefik/reference/routing-configuration/tcp/router/rules-and-priority/#hostsni-and-hostsniregexp
      - traefik.tcp.routers.slskd-listen.rule=HostSNI(`*`)
      - traefik.tcp.routers.slskd-listen.entrypoints=slskd-listen-50300-tcp
      - traefik.tcp.routers.slskd-listen.service=slskd-listen
      - traefik.tcp.services.slskd-listen.loadbalancer.server.port=50300
    networks:
      - traefik

  deunhealth:
    image: qmcgaw/deunhealth:latest@sha256:db1e4fcd3aceeb0da34a83f7a8a5432df586e6d0388ddb6ad8dd7b479e4aa25d
    container_name: deunhealth
    network_mode: "none"
    environment:
      - LOG_LEVEL=info
      - HEALTH_SERVER_ADDRESS=127.0.0.1:9999
      - TZ={{{global:TIMEZONE}}}
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  apprise:
    image: caronc/apprise:v1.3.1@sha256:6b112f8f174244f4a73b8e1254c9bde1fa562a6a428010aeaff1c18bc98d2713
    user: "0:0"
    environment:
      - APPRISE_WORKER_COUNT=1
      - APPRISE_STATEFUL_MODE=simple
      - APPRISE_DEFAULT_THEME=dark
      - APPRISE_DEFAULT_CONFIG_ID=homelab
      - APPRISE_CONFIG_LOCK=yes # should not be able to edit through UI
      # - PGID=0
      # - PUID=0
    volumes:
      - /docker/apprise/attach:/attach
      - /docker/apprise/plugin:/plugin
      - ./config:/config
    restart: unless-stopped
    # ports:
    #   - 8000:8000
    container_name: apprise
    labels:
      - traefik.enable=true
      - traefik.http.routers.apprise.rule=Host(`{{{domainForApp "apprise"}}}`)
      - traefik.http.routers.apprise.entrypoints=https
      - traefik.http.routers.apprise.tls=true
      - traefik.http.routers.apprise.tls.certresolver=porkbun
      - traefik.http.routers.apprise.service=apprise
      - traefik.http.services.apprise.loadbalancer.server.port=8000
      - traefik.http.routers.apprise.middlewares=oidc-auth@file
    networks:
      - traefik

  qbittorrent:
    image: ghcr.io/linuxserver/qbittorrent:5.1.4@sha256:5b09709bb0eff4edb551f5b30029952ab4d67aa0d5ca3526889124173bd78a9c
    container_name: qbittorrent
    restart: unless-stopped
    labels:
      - deunhealth.restart.on.unhealthy=true
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=0
      - PGID=0
      - TZ={{{global:TIMEZONE}}}
      - WEBUI_PORT=8081
      - TORRENTING_PORT=29730
    volumes:
      - /docker/qbittorrent:/config
      - /mnt/media:/data
    network_mode: service:gluetun
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 60s
      retries: 3
      start_period: 20s
      timeout: 10s

  nzbget:
    image: ghcr.io/linuxserver/nzbget:v25.4-ls228@sha256:51184d6996a33e79f5db2136c31724f3ce783fde708b3ef780f259e7f168e76a
    container_name: nzbget
    environment:
      - PUID=0
      - PGID=0
      - TZ={{{global:TIMEZONE}}}
    volumes:
      - /docker/nzbget:/config
      - /mnt/media:/data
    restart: unless-stopped
    network_mode: service:gluetun
    labels:
      - deunhealth.restart.on.unhealthy=true
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --timeout=3
        - --tries=1
        - --spider
        - http://127.0.0.1:6789/
      interval: 10s
      timeout: 5s
      retries: 8
      start_period: 15s

  slskd:
    image: slskd/slskd:0.24.3@sha256:bcf9820dab68e21d2bba8ebb1ffd583d71fcba542a50a1e998119f69b7b498fe
    container_name: slskd
    environment:
      - SLSKD_REMOTE_CONFIGURATION=true
    network_mode: service:gluetun
    labels:
      - deunhealth.restart.on.unhealthy=true
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    volumes:
      - /docker/slskd/data:/app/data
      - /docker/slskd/incomplete:/app/incomplete
      - /docker/slskd/scripts:/app/scripts
      - /mnt/media:/data
      - ./config/slskd.yml:/app/slskd.yml
    restart: always

  prowlarr:
    image: ghcr.io/linuxserver/prowlarr:2.3.0@sha256:d3e9307b320b6772749a2cf8fc2712e9e824c4930b034680ad4d08a9e2f25884
    container_name: prowlarr
    environment:
      - PUID=0
      - PGID=0
      - TZ={{{global:TIMEZONE}}}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /docker/prowlarr:/config
    restart: unless-stopped
    # ports:
    #   - 9696:9696
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --timeout=3
        - --tries=1
        - --spider
        - http://localhost:9696/ping
      interval: 10s
      timeout: 5s
      retries: 8
      start_period: 15s
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.prowlarr.rule=Host(`{{{domainForApp "prowlarr"}}}`)
      - traefik.http.routers.prowlarr.entrypoints=https
      - traefik.http.routers.prowlarr.tls=true
      - traefik.http.routers.prowlarr.tls.certresolver=porkbun
      - traefik.http.routers.prowlarr.service=prowlarr
      - traefik.http.services.prowlarr.loadbalancer.server.port=9696
      - traefik.http.routers.prowlarr.middlewares=oidc-auth@file
    networks:
      - traefik

  sonarr:
    image: ghcr.io/linuxserver/sonarr:4.0.16@sha256:02b4d538d351d6e35882a021c08e8600fe95d28860fb1dd724b597166e7221ca
    container_name: sonarr
    restart: unless-stopped
    environment:
      - PUID=0
      - PGID=0
      - TZ={{{global:TIMEZONE}}}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /docker/sonarr:/config
      - /mnt/media:/data
    # ports:
    #   - 8989:8989
    depends_on:
      qbittorrent:
        condition: service_healthy
        restart: true
      nzbget:
        condition: service_healthy
        restart: true
      prowlarr:
        condition: service_healthy
        restart: true
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --timeout=3
        - --tries=1
        - --spider
        - http://localhost:8989/ping
      interval: 5s
      timeout: 4s
      retries: 4
      start_period: 5s
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.sonarr.rule=Host(`{{{domainForApp "sonarr"}}}`)
      - traefik.http.routers.sonarr.entrypoints=https
      - traefik.http.routers.sonarr.tls=true
      - traefik.http.routers.sonarr.tls.certresolver=porkbun
      - traefik.http.routers.sonarr.service=sonarr
      - traefik.http.services.sonarr.loadbalancer.server.port=8989
      - traefik.http.routers.sonarr.middlewares=oidc-auth@file
    networks:
      - traefik

  radarr:
    image: ghcr.io/linuxserver/radarr:6.0.4@sha256:ba2693dd704b84eb0b404d40b3902bd3e62a1768dc5ee0d89b1f1d7cd51a66eb
    container_name: radarr
    restart: unless-stopped
    environment:
      - PUID=0
      - PGID=0
      - TZ={{{global:TIMEZONE}}}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /docker/radarr:/config
      - /mnt/media:/data
    # ports:
    #   - 7878:7878
    depends_on:
      qbittorrent:
        condition: service_healthy
        restart: true
      nzbget:
        condition: service_healthy
        restart: true
      prowlarr:
        condition: service_healthy
        restart: true
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --timeout=3
        - --tries=1
        - --spider
        - http://localhost:7878/ping
      interval: 5s
      timeout: 4s
      retries: 4
      start_period: 5s
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.radarr.rule=Host(`{{{domainForApp "radarr"}}}`)
      - traefik.http.routers.radarr.entrypoints=https
      - traefik.http.routers.radarr.tls=true
      - traefik.http.routers.radarr.tls.certresolver=porkbun
      - traefik.http.routers.radarr.service=radarr
      - traefik.http.services.radarr.loadbalancer.server.port=7878
      - traefik.http.routers.radarr.middlewares=oidc-auth@file
    networks:
      - traefik

  lidarr:
    container_name: lidarr
    image: ghcr.io/hotio/lidarr:pr-plugins-3.1.2.4913@sha256:ae0b3b14769fdfeb73fe5d9e61ebcda04edf202244bcbd6323d2fe1381154f57
    restart: unless-stopped
    depends_on:
      qbittorrent:
        condition: service_healthy
        restart: true
      nzbget:
        condition: service_healthy
        restart: true
      prowlarr:
        condition: service_healthy
        restart: true
    environment:
      - PUID=0
      - PGID=0
      - TZ={{{global:TIMEZONE}}}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /docker/lidarr:/config
      - /mnt/media:/data
    # ports:
    #   - 8686:8686
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --timeout=3
        - --tries=1
        - --spider
        - http://localhost:8686/ping
      interval: 5s
      timeout: 4s
      retries: 4
      start_period: 5s
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.lidarr.rule=Host(`{{{domainForApp "lidarr"}}}`)
      - traefik.http.routers.lidarr.entrypoints=https
      - traefik.http.routers.lidarr.tls=true
      - traefik.http.routers.lidarr.tls.certresolver=porkbun
      - traefik.http.routers.lidarr.service=lidarr
      - traefik.http.services.lidarr.loadbalancer.server.port=8686
      - traefik.http.routers.lidarr.middlewares=oidc-auth@file
    networks:
      - traefik

  bazarr:
    image: ghcr.io/linuxserver/bazarr:1.5.5@sha256:d40ee61030a9afafddfdd58d160281b865bfcad7cb66e920116fd6fd40668cbb
    container_name: bazarr
    restart: unless-stopped
    environment:
      - PUID=0
      - PGID=0
      - TZ={{{global:TIMEZONE}}}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /docker/bazarr:/config
      - /mnt/media:/data
    # ports:
    #   - 6767:6767
    depends_on:
      sonarr:
        condition: service_healthy
        restart: true
      radarr:
        condition: service_healthy
        restart: true
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --timeout=3
        - --tries=1
        - --spider
        - http://127.0.0.1:6767
      interval: 5s
      timeout: 4s
      retries: 4
      start_period: 15s
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.bazarr.rule=Host(`{{{domainForApp "bazarr"}}}`)
      - traefik.http.routers.bazarr.entrypoints=https
      - traefik.http.routers.bazarr.tls=true
      - traefik.http.routers.bazarr.tls.certresolver=porkbun
      - traefik.http.routers.bazarr.service=bazarr
      - traefik.http.services.bazarr.loadbalancer.server.port=6767
      - traefik.http.routers.bazarr.middlewares=oidc-auth@file
    networks:
      - traefik

  subsyncarr:
    image: mrorbitman/subsyncarr:0.0.8@sha256:5185ff4d403e1267fc38a30dcf13c631ebf4ff0e56a8bbb1dc1da70996bf2b83
    container_name: subsyncarr
    user: 0:0
    # run every 30 minutes (1800 seconds). workaround since builtin cron functionality doesn't work
    command: "sh -c 'set -x && while true; do /app/startup.sh & sleep 1800 && killall startup.sh tail; done'"
    volumes:
      - /mnt/media/movies:/movies
      - /mnt/media/tv:/tv
    restart: unless-stopped
    environment:
      - TZ={{{global:TIMEZONE}}}
      - SCAN_PATHS=/movies,/tv # Remember to mount these as volumes. Must begin with /. Default value is '/scan_dir'
      # - EXCLUDE_PATHS=/movies/temp,/tv/downloads # Exclude certain sub-directories from the scan
      - MAX_CONCURRENT_SYNC_TASKS=1 # Defaults to 1 if not set. Higher number will consume more CPU but sync your library faster
      - INCLUDE_ENGINES=ffsubsync,autosubsync # If not set, all engines are used by default

  profilarr:
    image: santiagosayshey/profilarr:v1.1.4@sha256:8a514f8429cd33885166facc9eb6504fa9ded056c737609e5e8ef32ae0afb350
    container_name: profilarr
    user: 0:0
    # ports:
    #   - 6868:6868
    volumes:
      - /docker/profilarr:/config
    environment:
      - TZ={{{global:TIMEZONE}}}
    restart: unless-stopped
    depends_on:
      sonarr:
        condition: service_healthy
        restart: true
      radarr:
        condition: service_healthy
        restart: true
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.profilarr.rule=Host(`{{{domainForApp "profilarr"}}}`)
      - traefik.http.routers.profilarr.entrypoints=https
      - traefik.http.routers.profilarr.tls=true
      - traefik.http.routers.profilarr.tls.certresolver=porkbun
      - traefik.http.routers.profilarr.service=profilarr
      - traefik.http.services.profilarr.loadbalancer.server.port=6868
      - traefik.http.routers.profilarr.middlewares=oidc-auth@file
    networks:
      - traefik
    # healthcheck:
    #   test:
    #     - CMD
    #     - wget
    #     - --quiet
    #     - --timeout=3
    #     - --tries=1
    #     - --spider
    #     - http://127.0.0.1:6868
    #   interval: 5s
    #   timeout: 4s
    #   retries: 4
    #   start_period: 5s

  cleanuparr:
    image: ghcr.io/cleanuparr/cleanuparr:2.5.1@sha256:47bb76b03676d5b9bb3c7a01f1a9005066d60db63b3f8379057d77f89daa6c37
    container_name: cleanuparr
    restart: unless-stopped
    depends_on:
      sonarr:
        condition: service_healthy
        restart: true
      radarr:
        condition: service_healthy
        restart: true
      lidarr:
        condition: service_healthy
        restart: true
      qbittorrent:
        condition: service_healthy
        restart: true
      nzbget:
        condition: service_healthy
        restart: true
    # ports:
    #   - 11011:11011
    volumes:
      - /docker/cleanuparr:/config
      - /mnt/media:/data
    # https://cleanuparr.github.io/Cleanuparr/docs/installation/detailed#environment-variables
    environment:
      - PORT=11011
      - BASE_PATH=
      - PUID=0
      - PGID=0
      - UMASK=022
      - TZ={{{global:TIMEZONE}}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11011/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.cleanuparr.rule=Host(`{{{domainForApp "cleanuparr"}}}`)
      - traefik.http.routers.cleanuparr.entrypoints=https
      - traefik.http.routers.cleanuparr.tls=true
      - traefik.http.routers.cleanuparr.tls.certresolver=porkbun
      - traefik.http.routers.cleanuparr.service=cleanuparr
      - traefik.http.services.cleanuparr.loadbalancer.server.port=11011
      - traefik.http.routers.cleanuparr.middlewares=oidc-auth@file
    networks:
      - traefik

  huntarr:
    image: huntarr/huntarr:9.1.4@sha256:9e08e9ec5718c11a4731dad2ee2e1217c10633e6b8d1af7edad60e5fe57fff58
    container_name: huntarr
    restart: unless-stopped
    # ports:
    #   - "9705:9705"
    depends_on:
      sonarr:
        condition: service_healthy
        restart: true
      radarr:
        condition: service_healthy
        restart: true
      lidarr:
        condition: service_healthy
        restart: true
      qbittorrent:
        condition: service_healthy
        restart: true
      nzbget:
        condition: service_healthy
        restart: true
    volumes:
      - /docker/huntarr:/config
    environment:
      - TZ={{{global:TIMEZONE}}}
    labels:
      - deunhealth.restart.on.unhealthy=true
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.huntarr.rule=Host(`{{{domainForApp "huntarr"}}}`)
      - traefik.http.routers.huntarr.entrypoints=https
      - traefik.http.routers.huntarr.tls=true
      - traefik.http.routers.huntarr.tls.certresolver=porkbun
      - traefik.http.routers.huntarr.service=huntarr
      - traefik.http.services.huntarr.loadbalancer.server.port=9705
      - traefik.http.routers.huntarr.middlewares=oidc-auth@file
    networks:
      - traefik

networks:
  traefik:
    external: true
