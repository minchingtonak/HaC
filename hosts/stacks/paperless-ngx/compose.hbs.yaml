services:
  webserver:
    image: ghcr.io/paperless-ngx/paperless-ngx:2.19.5@sha256:5f2a72fd7be42c6b1d8fa1751606a140452d4c3e6e829ae6b1b15e3c95129481
    container_name: paperless-webserver
    restart: unless-stopped
    depends_on:
      - db
      - broker
    # ports:
    #   - "8000:8000"
    volumes:
      - /mnt/documents/intake:/usr/src/paperless/consume
      - /docker/paperless-ngx/data:/usr/src/paperless/data
      - /docker/paperless-ngx/export:/usr/src/paperless/export
      - /mnt/documents/paperless:/usr/src/paperless/media
    user: 0:0
    # https://docs.paperless-ngx.com/configuration
    environment:
      USERMAP_UID: 0
      USERMAP_GID: 0
      PAPERLESS_APPS: allauth.socialaccount.providers.openid_connect
      PAPERLESS_SOCIALACCOUNT_PROVIDERS: '{"openid_connect":{"SCOPE":["openid","profile","email"],"OAUTH_PKCE_ENABLED":true,"APPS":[{"provider_id":"pocket-id","name":"Pocket ID","client_id":"{{{SECRET_OIDC_CLIENT_ID}}}","secret":"{{{SECRET_OIDC_CLIENT_SECRET}}}","settings":{"server_url":"{{{oidc:PROVIDER_URL}}}"}}]}}'
      PAPERLESS_APP_TITLE: paperless-ngx
      PAPERLESS_URL: https://{{{domainForApp "paperless-ngx"}}}
      PAPERLESS_REDIS: redis://broker:6379
      PAPERLESS_DBHOST: db
      PAPERLESS_TIME_ZONE: "{{{global:TIMEZONE}}}"
      PAPERLESS_CONSUMPTION_DIR: /usr/src/paperless/consume
      PAPERLESS_CONSUMER_RECURSIVE: true
      PAPERLESS_DATA_DIR: /usr/src/paperless/data
      # PAPERLESS_EMPTY_TRASH_DIR: /usr/src/paperless/media/trash
      PAPERLESS_EMPTY_TRASH_DELAY: 7
      PAPERLESS_MEDIA_ROOT: /usr/src/paperless/media
      # https://docs.paperless-ngx.com/advanced_usage/#file-name-handling
      # use the following to migrate files after changing filename format: https://docs.paperless-ngx.com/administration/#renamer
      # remove spaces from file/folder names
      PAPERLESS_FILENAME_FORMAT: '{{{{raw}}}}{% filter replace(" ", "") %}{{ custom_fields.Category.value }}/{{ correspondent }}/{{ created }}_{{ title }}{% endfilter %}{{{{/raw}}}}'
      PAPERLESS_FILENAME_FORMAT_REMOVE_NONE: false
      PAPERLESS_FILENAME_DATE_ORDER: YMD # check document filenames for dates in ISO-8601 format
      PAPERLESS_LOGGING_DIR: /usr/src/paperless/data/log
      PAPERLESS_OCR_CLEAN: clean
      PAPERLESS_OCR_DESKEW: true
      PAPERLESS_OCR_ROTATE_PAGES: true
      PAPERLESS_OCR_OUTPUT_TYPE: pdfa
      PAPERLESS_DATE_ORDER: MDY # check document content for dates in US format
      # admin user credential config seems to have no effect
      PAPERLESS_ADMIN_USER: "{{{SECRET_ADMIN_USERNAME}}}"
      PAPERLESS_ADMIN_PASSWORD: "{{{SECRET_ADMIN_PASSWORD}}}"
      PAPERLESS_WEBSERVER_WORKERS: 2
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://gotenberg:3000
      PAPERLESS_TIKA_ENDPOINT: http://tika:9998
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.paperlessngx.rule=Host(`{{{domainForApp "paperless-ngx"}}}`)
      - traefik.http.routers.paperlessngx.entrypoints=https
      - traefik.http.routers.paperlessngx.tls=true
      - traefik.http.routers.paperlessngx.tls.certresolver=porkbun
      - traefik.http.routers.paperlessngx.service=paperlessngx
      - traefik.http.services.paperlessngx.loadbalancer.server.port=8000
    networks:
      - paperless
      - traefik

  broker:
    # pinned
    image: docker.io/library/redis:7@sha256:4a36f83c7f44b96953a7691b949ec77d8b96723623dd0b984c63d8615accb99c
    container_name: paperless-broker
    restart: unless-stopped
    volumes:
      - /docker/paperless-ngx/redisdata:/data
    networks:
      - paperless

  db:
    # pinned
    image: docker.io/library/postgres:16@sha256:fd4208c8aadb92850e7e86a584fe8b1f2a6af8949feeb1ac8e12e72324573676
    container_name: paperless-db
    restart: unless-stopped
    volumes:
      - /docker/paperless-ngx/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      POSTGRES_PASSWORD: paperless
    networks:
      - paperless

  gotenberg:
    # pinned
    image: docker.io/gotenberg/gotenberg:8.20@sha256:cda4386c7ed38f18bc6897828be01ba7361c99929a5c84ec5e293d7916e29bac
    container_name: paperless-gotenberg
    restart: unless-stopped
    # The gotenberg chromium route is used to convert .eml files. We do not
    # want to allow external content like tracking pixels or even javascript.
    command:
      - "gotenberg"
      - "--api-timeout=600s"
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"
    networks:
      - paperless

  tika:
    image: docker.io/apache/tika:3.2.3.0@sha256:c0154cb95587cde64be74f35ada1a2bd7892219f3f0ac3c9dc6cab34046b3573
    container_name: paperless-tika
    restart: unless-stopped
    networks:
      - paperless

networks:
  paperless:
  traefik:
    external: true
