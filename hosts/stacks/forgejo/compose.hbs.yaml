services:
  server:
    image: codeberg.org/forgejo/forgejo:14.0.1@sha256:d59b504313ef3107d9f2e8ce04dd133b4c78218810174a1b2592c1232b0aa888
    container_name: forgejo
    environment:
      - USER_UID=1000
      - USER_GID=1000
    restart: always
    volumes:
      - /docker/forgejo:/data
      # NOTE: for first-time setup, comment the below line out, otherwise forgejo will not go into setup mode
      - ./conf/app.ini:/data/gitea/conf/app.ini:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    # ports:
    #   - "3000:3000"
    #   - "222:22"
    labels:
      - traefik.enable=true
      - traefik.http.routers.forgejo.rule=Host(`{{{domainForApp "forgejo"}}}`)
      - traefik.http.routers.forgejo.entrypoints=https
      - traefik.http.routers.forgejo.tls=true
      - traefik.http.routers.forgejo.tls.certresolver=porkbun
      - traefik.http.routers.forgejo.service=forgejo
      - traefik.http.services.forgejo.loadbalancer.server.port=3000
      #
      - traefik.tcp.routers.forgejo-ssh.rule=HostSNI(`*`)
      - traefik.tcp.routers.forgejo-ssh.entrypoints=ssh-222-tcp
      - traefik.tcp.routers.forgejo-ssh.service=forgejo-ssh
      - traefik.tcp.services.forgejo-ssh.loadbalancer.server.port=22
    networks:
      - traefik

networks:
  traefik:
    external: true
